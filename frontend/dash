<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Software Marketplace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: 'Roboto', Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
    .container { padding: 20px; max-width: 1400px; margin: auto; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
    .welcome { font-size: 1.1rem; }

    .tab-container { margin-top: 20px; }
    .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab-btn { padding: 10px 20px; background: #eee; border: none; border-radius: 20px; cursor: pointer; font-weight: 500; }
    .tab-btn.active { background: #3498db; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* YouTube-style grid layout */
    .software-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      padding: 10px 0;
    }

    .software-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .software-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .thumbnail-container {
      position: relative;
      width: 100%;
      height: 180px;
      overflow: hidden;
      background: #000;
    }

    .thumbnail-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .play-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .thumbnail-container:hover .play-overlay {
      opacity: 1;
    }

    .play-icon {
      color: white;
      font-size: 24px;
      margin-left: 4px;
    }

    .card-content {
      padding: 12px;
    }

    .software-title {
      font-size: 1rem;
      font-weight: 500;
      margin: 0 0 8px 0;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      color: #0f0f0f;
    }

    .software-meta {
      color: #606060;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    .software-price {
      font-weight: 600;
      color: #0f0f0f;
      font-size: 1rem;
      margin-bottom: 12px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-group button {
      padding: 8px 16px;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-download { 
      background: #27ae60; 
      color: white; 
    }
    .btn-download:hover:not(:disabled) { 
      background: #219653; 
    }
    .btn-download:disabled { 
      background: #95a5a6; 
      cursor: not-allowed; 
    }
    .btn-buy { 
      background: #e74c3c; 
      color: white; 
    }
    .btn-buy:hover { 
      background: #c0392b; 
    }
    .btn-edit { 
      background: #3498db; 
      color: white; 
    }
    .btn-edit:hover { 
      background: #2980b9; 
    }

    .purchase-badge { 
      background-color: #27ae60; 
      color: white; 
      padding: 2px 8px; 
      border-radius: 10px; 
      font-size: 0.75rem; 
      margin-left: 8px;
    }

    .upload-btn, .admin-btn, .logout-btn {
      margin-left: 10px;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
    }
    .upload-btn { background: #3498db; }
    .upload-btn:hover { background: #2980b9; }
    .admin-btn { background: #9b59b6; }
    .admin-btn:hover { background: #8e44ad; }
    .logout-btn { background: #e74c3c; }
    .logout-btn:hover { background: #c0392b; }

    /* IMPROVED Category Filter Styles */
    .category-filter {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      position: relative;
      z-index: 100;
    }

    .filter-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-weight: 500;
      color: #0f0f0f;
      white-space: nowrap;
    }

    /* Category Dropdown */
    .category-dropdown {
      position: relative;
      min-width: 200px;
    }

    .category-select {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: border-color 0.2s;
    }

    .category-select:hover {
      border-color: #3498db;
    }

    .category-select.active {
      border-color: #3498db;
      background: #f8f9fa;
    }

    .category-options {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: white;
      border: 2px solid #3498db;
      border-top: none;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }

    .category-options.show {
      display: block;
    }

    .category-option {
      padding: 12px 15px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #f1f1f1;
    }

    .category-option:last-child {
      border-bottom: none;
    }

    .category-option:hover {
      background: #f8f9fa;
    }

    .category-option.active {
      background: #3498db;
      color: white;
    }

    .category-chip {
      display: inline-block;
      background: #3498db;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-top: 5px;
    }

    .search-box {
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      width: 250px;
      transition: border-color 0.2s;
    }

    .search-box:focus {
      outline: none;
      border-color: #3498db;
    }

    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .results-count {
      color: #606060;
      font-size: 0.9rem;
    }

    /* Download status */
    .download-status {
      margin: 8px 0;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .download-allowed { 
      background: #d4edda; 
      color: #155724; 
      border: 1px solid #c3e6cb; 
    }
    .download-denied { 
      background: #f8d7da; 
      color: #721c24; 
      border: 1px solid #f5c6cb; 
    }

    /* Fullscreen modals */
    #uploadModal, #editModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 1000;
      overflow-y: auto;
      padding: 20px 0;
    }

    .modal-content {
      background: #fff;
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      padding: 30px;
      border-radius: 12px;
      position: relative;
      box-sizing: border-box;
    }

    .modal-content h2 {
      margin-top: 0;
      color: #0f0f0f;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #606060;
      z-index: 1001;
    }

    .modal-actions {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    input[type="text"], input[type="number"], input[type="file"], select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 1rem;
      box-sizing: border-box;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    label { 
      font-weight: 500; 
      display: block; 
      color: #0f0f0f;
    }

    small {
      display: block;
      color: #666;
      font-size: 0.8rem;
      margin-top: -10px;
      margin-bottom: 15px;
    }

    /* Admin badge */
    .admin-badge {
      background-color: #9b59b6;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-left: 10px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #606060;
      grid-column: 1 / -1;
    }

    .empty-state h3 {
      margin-bottom: 10px;
      color: #0f0f0f;
    }

    /* Video modal for fullscreen playback */
    .video-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .video-modal video {
      max-width: 90%;
      max-height: 90%;
    }

    .close-video {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      background: none;
      border: none;
    }

    /* Clear filter button */
    .clear-filter {
      background: #95a5a6;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.2s;
    }

    .clear-filter:hover {
      background: #7f8c8d;
    }

    .clear-filter:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    /* Active filter indicator */
    .active-filter {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: #e8f4fd;
      border: 1px solid #3498db;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    .active-filter span {
      color: #3498db;
      font-weight: 500;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .category-filter {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .filter-controls {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filter-group {
        width: 100%;
      }
      
      .category-dropdown, .search-box {
        width: 100%;
      }
      
      .modal-content {
        margin: 10px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1 style="color: #0f0f0f; margin: 0;">Software Marketplace</h1>
        <p class="welcome" style="color: #606060; margin: 5px 0 0 0;">Welcome, <strong id="username" style="color: #0f0f0f;">User</strong><span id="adminBadge" class="admin-badge" style="display:none;">Admin</span>!</p>
      </div>
      <div>
        <button class="admin-btn" onclick="goToAdminPanel()" style="display:none;">‚öôÔ∏è Admin Panel</button>
        <button class="upload-btn" onclick="showUploadForm()" style="display:none;">üì§ Upload Software</button>
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
      </div>
    </header>

    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-btn active" onclick="showTab('marketplace')">üõí Marketplace</button>
        <button class="tab-btn" onclick="showTab('my-uploads')">üì§ My Uploads</button>
        <button class="tab-btn" onclick="showTab('my-purchases')">üì• My Purchases</button>
      </div>

      <div id="marketplaceTab" class="tab-content active">
        <div class="filter-header">
          <h2 style="color: #0f0f0f; margin: 0;">Available Software</h2>
          <div class="results-count" id="resultsCount"></div>
        </div>
        
        <!-- IMPROVED Category Filter -->
        <div class="category-filter">
          <div class="filter-controls">
            <div class="filter-group">
              <label class="filter-label">Filter by Category:</label>
              <div class="category-dropdown">
                <div class="category-select" id="categorySelect">
                  <span>All Categories</span>
                  <span>‚ñº</span>
                </div>
                <div class="category-options" id="categoryOptions">
                  <div class="category-option active" data-category="all">All Categories</div>
                  <!-- Categories will be loaded dynamically -->
                </div>
              </div>
            </div>
            
            <div class="filter-group">
              <input type="text" class="search-box" id="searchBox" placeholder="Search software...">
            </div>
          </div>
          
          <div id="activeFilter" class="active-filter" style="display: none;">
            <span>Active filter: <strong id="activeFilterText">All Categories</strong></span>
            <button class="clear-filter" onclick="clearFilters()">Clear</button>
          </div>
        </div>
        
        <div id="softwareList" class="software-grid"><p>Loading...</p></div>
      </div>
      
      <div id="myUploadsTab" class="tab-content">
        <h2 style="color: #0f0f0f; margin-bottom: 10px;">My Uploaded Software</h2>
        <div id="myUploadsList" class="software-grid"><p>Loading...</p></div>
      </div>
      
      <div id="myPurchasesTab" class="tab-content">
        <h2 style="color: #0f0f0f; margin-bottom: 10px;">My Purchased Software</h2>
        <div id="myPurchasesList" class="software-grid"><p>Loading...</p></div>
      </div>
    </div>
  </div>

  <!-- Video Modal for fullscreen playback -->
  <div class="video-modal" id="videoModal">
    <button class="close-video" onclick="closeVideoModal()">√ó</button>
    <video id="fullscreenVideo" controls></video>
  </div>

  <!-- Fullscreen Upload Modal -->
  <div id="uploadModal">
    <div class="modal-content">
      <span class="close-btn" onclick="hideUploadForm()">&times;</span>
      <h2>üì§ Upload Your Software</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <label>Title:</label>
        <input type="text" id="title" name="title" required />

        <label>Category:</label>
        <select id="category" name="category" required>
          <option value="">Select a category</option>
          <option value="Productivity">Productivity</option>
          <option value="Games">Games</option>
          <option value="Education">Education</option>
          <option value="Development">Development</option>
          <option value="Design">Design</option>
          <option value="Business">Business</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Utilities">Utilities</option>
          <option value="Other">Other</option>
        </select>

        <label>Description:</label>
        <textarea id="description" name="description" placeholder="Describe your software..."></textarea>

        <label>Demo Video (MP4):</label>
        <input type="file" id="video" name="video" accept="video/mp4" required />

        <label>Software ZIP File:</label>
        <input type="file" id="zipFile" name="zipFile" accept=".zip" required />

        <label>Price ($):</label>
        <input type="number" id="price" name="price" step="0.01" min="0" required />

        <div class="modal-actions">
          <button type="button" onclick="hideUploadForm()" style="background: #95a5a6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
          <button type="submit" style="background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Upload</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal">
    <div class="modal-content">
      <span class="close-btn" onclick="hideEditForm()">&times;</span>
      <h2>‚úèÔ∏è Edit Software</h2>
      <form id="editForm" enctype="multipart/form-data">
        <input type="hidden" id="editId" name="id">

        <label>Title:</label>
        <input type="text" id="editTitle" name="title" required />

        <label>Category:</label>
        <select id="editCategory" name="category" required>
          <option value="">Select a category</option>
          <option value="Productivity">Productivity</option>
          <option value="Games">Games</option>
          <option value="Education">Education</option>
          <option value="Development">Development</option>
          <option value="Design">Design</option>
          <option value="Business">Business</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Utilities">Utilities</option>
          <option value="Other">Other</option>
        </select>

        <label>Description:</label>
        <textarea id="editDescription" name="description" placeholder="Describe your software..."></textarea>

        <label>Demo Video (MP4):</label>
        <input type="file" id="editVideo" name="video" accept="video/mp4" />
        <small>Leave empty to keep current video</small>

        <label>Software ZIP File:</label>
        <input type="file" id="editZipFile" name="zipFile" accept=".zip" />
        <small>Leave empty to keep current ZIP file</small>

        <label>Price ($):</label>
        <input type="number" id="editPrice" name="price" step="0.01" min="0" required />

        <div class="modal-actions">
          <button type="button" onclick="hideEditForm()" style="background: #95a5a6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
          <button type="submit" style="background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Update Software</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API = "http://192.168.1.34:8080/api";
    const username = localStorage.getItem('username');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';
    
    // Global variables for filtering
    let allSoftware = [];
    let currentCategory = 'all';
    let currentSearch = '';

    document.getElementById("username").textContent = username || "Guest";
    
    // Show admin badge if user is admin
    if (isAdmin) {
      document.getElementById("adminBadge").style.display = 'inline';
    }

    // Current software being edited
    let currentEditingSoftware = null;
    // Track active PayPal payment buttons
    const activePayPalButtons = {};
    // Cache for purchase status to avoid repeated API calls
    const purchaseStatusCache = {};

    // Category dropdown functionality
    function setupCategoryDropdown() {
      const categorySelect = document.getElementById('categorySelect');
      const categoryOptions = document.getElementById('categoryOptions');
      
      // Toggle dropdown
      categorySelect.addEventListener('click', function(e) {
        e.stopPropagation();
        categoryOptions.classList.toggle('show');
        categorySelect.classList.toggle('active');
      });
      
      // Handle category selection
      categoryOptions.addEventListener('click', function(e) {
        if (e.target.classList.contains('category-option')) {
          const category = e.target.getAttribute('data-category');
          const categoryName = e.target.textContent;
          
          // Update selected category
          selectCategory(category, categoryName);
          
          // Close dropdown
          categoryOptions.classList.remove('show');
          categorySelect.classList.remove('active');
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function() {
        categoryOptions.classList.remove('show');
        categorySelect.classList.remove('active');
      });
    }
    
    // Select category and update UI
    function selectCategory(category, categoryName) {
      currentCategory = category;
      
      // Update dropdown text
      document.querySelector('#categorySelect span:first-child').textContent = categoryName;
      
      // Update active option
      document.querySelectorAll('.category-option').forEach(option => {
        option.classList.remove('active');
        if (option.getAttribute('data-category') === category) {
          option.classList.add('active');
        }
      });
      
      // Show/hide active filter indicator
      const activeFilter = document.getElementById('activeFilter');
      const activeFilterText = document.getElementById('activeFilterText');
      
      if (category === 'all') {
        activeFilter.style.display = 'none';
      } else {
        activeFilterText.textContent = categoryName;
        activeFilter.style.display = 'flex';
      }
      
      // Apply filters
      applyFilters();
    }
    
    // Clear all filters
    function clearFilters() {
      currentCategory = 'all';
      currentSearch = '';
      
      // Reset UI
      document.querySelector('#categorySelect span:first-child').textContent = 'All Categories';
      document.getElementById('searchBox').value = '';
      document.getElementById('activeFilter').style.display = 'none';
      
      // Update active option
      document.querySelectorAll('.category-option').forEach(option => {
        option.classList.remove('active');
        if (option.getAttribute('data-category') === 'all') {
          option.classList.add('active');
        }
      });
      
      // Apply filters (will show all software)
      applyFilters();
    }

    // Logout function
    function logout() {
      if (confirm("Are you sure you want to logout?")) {
        // Clear all stored user data
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        localStorage.removeItem('isAdmin');

        // Redirect to login page
        window.location.href = 'index.html';
      }
    }

    function showTab(tabName) {
      const tabMap = {
        "marketplace": "marketplaceTab",
        "my-uploads": "myUploadsTab",
        "my-purchases": "myPurchasesTab"
      };

      const tabId = tabMap[tabName];
      if (!tabId) return;

      document.querySelectorAll(".tab-content").forEach(tab => {
        tab.classList.remove("active");
        tab.style.display = "none";
      });

      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.remove("active");
      });

      const tabElement = document.getElementById(tabId);
      if (tabElement) {
        tabElement.classList.add("active");
        tabElement.style.display = "block";
      }

      const button = document.querySelector(`.tab-btn[onclick="showTab('${tabName}')"]`);
      if (button) button.classList.add("active");

      // Show Upload button only on My Uploads
      const uploadBtn = document.querySelector(".upload-btn");
      if (tabName === "my-uploads") {
        uploadBtn.style.display = 'inline-block';
      } else {
        uploadBtn.style.display = 'none';
      }

      if (tabName === "marketplace") loadMarketplace();
      else if (tabName === "my-uploads") loadMyUploads();
      else if (tabName === "my-purchases") loadMyPurchases();
    }

    function showUploadForm() {
      document.getElementById("uploadModal").style.display = "block";
      // Prevent body scrolling when modal is open
      document.body.style.overflow = 'hidden';
    }

    function hideUploadForm() {
      document.getElementById("uploadModal").style.display = "none";
      document.getElementById("uploadForm").reset();
      // Restore body scrolling
      document.body.style.overflow = 'auto';
    }

    function showEditForm() {
      document.getElementById("editModal").style.display = "block";
      // Prevent body scrolling when modal is open
      document.body.style.overflow = 'hidden';
    }

    function hideEditForm() {
      document.getElementById("editModal").style.display = "none";
      document.getElementById("editForm").reset();
      currentEditingSoftware = null;
      // Restore body scrolling
      document.body.style.overflow = 'auto';
    }

    function goToAdminPanel() {
      window.location.href = "admin.html";
    }

    // Video modal functions
    function openVideoModal(videoUrl) {
      const videoModal = document.getElementById('videoModal');
      const fullscreenVideo = document.getElementById('fullscreenVideo');
      fullscreenVideo.src = videoUrl;
      videoModal.style.display = 'flex';
      fullscreenVideo.play();
    }

    function closeVideoModal() {
      const videoModal = document.getElementById('videoModal');
      const fullscreenVideo = document.getElementById('fullscreenVideo');
      fullscreenVideo.pause();
      fullscreenVideo.src = '';
      videoModal.style.display = 'none';
    }

    // Close video modal when clicking outside the video
    document.getElementById('videoModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeVideoModal();
      }
    });

    // Load categories from backend
    async function loadCategories() {
      try {
        const response = await fetch(`${API}/software/categories`);
        if (response.ok) {
          const categories = await response.json();
          displayCategories(categories);
        } else {
          // Use default categories if API fails
          const defaultCategories = [
            'Productivity', 'Games', 'Education', 'Development', 
            'Design', 'Business', 'Entertainment', 'Utilities', 'Other'
          ];
          displayCategories(defaultCategories);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
        // Use default categories on error
        const defaultCategories = [
          'Productivity', 'Games', 'Education', 'Development', 
          'Design', 'Business', 'Entertainment', 'Utilities', 'Other'
        ];
        displayCategories(defaultCategories);
      }
    }

    // Display categories in dropdown
    function displayCategories(categories) {
      const categoryOptions = document.getElementById('categoryOptions');
      
      // Clear existing options (keep "All Categories")
      const allCategoriesOption = categoryOptions.querySelector('.category-option[data-category="all"]');
      categoryOptions.innerHTML = '';
      categoryOptions.appendChild(allCategoriesOption);
      
      // Add categories to dropdown
      categories.forEach(category => {
        const option = document.createElement('div');
        option.className = 'category-option';
        option.setAttribute('data-category', category);
        option.textContent = category;
        categoryOptions.appendChild(option);
      });
    }

    // Search software
    function searchSoftware() {
      currentSearch = document.getElementById('searchBox').value.toLowerCase();
      applyFilters();
    }

    // Apply both category and search filters
    function applyFilters() {
      let filteredSoftware = allSoftware;
      
      // Apply category filter
      if (currentCategory !== 'all') {
        filteredSoftware = filteredSoftware.filter(software => 
          software.category === currentCategory
        );
      }
      
      // Apply search filter
      if (currentSearch) {
        filteredSoftware = filteredSoftware.filter(software =>
          software.title.toLowerCase().includes(currentSearch) ||
          (software.category && software.category.toLowerCase().includes(currentSearch)) ||
          (software.description && software.description.toLowerCase().includes(currentSearch)) ||
          (software.uploadedBy && software.uploadedBy.toLowerCase().includes(currentSearch))
        );
      }
      
      // Update results count
      document.getElementById('resultsCount').textContent = 
        `Showing ${filteredSoftware.length} of ${allSoftware.length} results`;
      
      // Display filtered software
      displayFilteredSoftware(filteredSoftware);
    }

    // Display filtered software
    function displayFilteredSoftware(softwareList) {
      const container = document.getElementById("softwareList");
      container.innerHTML = "";

      if (softwareList.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No software found</h3>
            <p>Try changing your filters or search terms</p>
            <button class="clear-filter" onclick="clearFilters()" style="margin-top: 10px;">Clear All Filters</button>
          </div>
        `;
        return;
      }

      // Display software
      softwareList.forEach(s => {
        const isOwner = s.uploadedBy === username;
        const canDownload = purchaseStatusCache[s.id] || isOwner || isAdmin;
        const videoUrl = `${API.replace('/api','')}${s.videoUrl}`;
        
        container.innerHTML += `
          <div class="software-card">
            <div class="thumbnail-container" onclick="openVideoModal('${videoUrl}')">
              <video>
                <source src="${videoUrl}" type="video/mp4">
              </video>
              <div class="play-overlay">
                <span class="play-icon">‚ñ∂</span>
              </div>
            </div>
            <div class="card-content">
              <h3 class="software-title" title="${escapeHtml(s.title)}">${escapeHtml(s.title)}</h3>
              <div class="software-meta">
                By ${s.uploadedBy || 'Unknown'}
                ${s.category ? `<span class="category-chip">${s.category}</span>` : ''}
              </div>
              ${s.description ? `<p style="font-size: 0.85rem; color: #606060; margin-bottom: 8px;">${escapeHtml(s.description)}</p>` : ''}
              <div class="software-price">$${s.price.toFixed(2)}</div>
              
              <div class="download-status ${canDownload ? 'download-allowed' : 'download-denied'}">
                ${canDownload ? 
                  '‚úÖ Download available' : 
                  '‚ùå Purchase required'
                }
              </div>
              
              <div class="card-actions">
                <button class="btn-download" id="download-btn-${s.id}" 
                  onclick="event.stopPropagation(); downloadSoftware(${s.id}, '${escapeHtml(s.title)}')"
                  ${!canDownload ? 'disabled' : ''}>
                  üì• Download
                </button>
                
                ${isOwner ?
                  `<button class="btn-edit" onclick="event.stopPropagation(); editSoftware(${s.id})">‚úèÔ∏è Edit</button>` :
                  `<button class="btn-buy" id="buy-btn-${s.id}" onclick="event.stopPropagation(); purchaseSoftware(${s.id}, ${s.price}, '${escapeHtml(s.title)}')">üí≥ Buy</button>`
                }
              </div>
            </div>
          </div>`;
      });
    }

    // Check if user can download software
    async function canDownloadSoftware(softwareId) {
      const token = localStorage.getItem("token");
      if (!token) return false;

      // Check cache first
      if (purchaseStatusCache[softwareId] !== undefined) {
        return purchaseStatusCache[softwareId];
      }

      try {
        const response = await fetch(`${API}/payment/purchases/check/${softwareId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          purchaseStatusCache[softwareId] = data.hasPurchased;
          return data.hasPurchased;
        }
        return false;
      } catch (error) {
        console.error('Error checking purchase status:', error);
        return false;
      }
    }

    // Secure download function
    async function downloadSoftware(softwareId, softwareTitle) {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Please login to download software.");
        return;
      }

      try {
        // Show loading state
        const downloadBtn = document.getElementById(`download-btn-${softwareId}`);
        if (downloadBtn) {
          downloadBtn.textContent = "‚è≥ Checking...";
          downloadBtn.disabled = true;
        }

        // Use the secure download endpoint
        const response = await fetch(`${API}/software/download/${softwareId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          // Get the file blob
          const blob = await response.blob();
          
          // Create download link
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${softwareTitle}.zip` || 'software.zip';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          
          alert("‚úÖ Download started!");
        } else {
          const errorText = await response.text();
          if (response.status === 403) {
            alert("‚ùå You need to purchase this software before downloading.");
          } else if (response.status === 404) {
            alert("‚ùå File not found. Please contact support.");
          } else {
            alert(`‚ùå Download failed: ${errorText}`);
          }
        }
      } catch (error) {
        console.error('Download error:', error);
        alert("‚ùå Network error during download. Please try again.");
      } finally {
        // Restore button state
        const downloadBtn = document.getElementById(`download-btn-${softwareId}`);
        if (downloadBtn) {
          downloadBtn.textContent = "üì• Download";
          downloadBtn.disabled = false;
        }
      }
    }

    async function loadMarketplace() {
      try {
        const res = await fetch(`${API}/software/list`);
        if (!res.ok) throw new Error(`Error ${res.status}`);
        allSoftware = await res.json();
        
        // Load categories and setup dropdown
        await loadCategories();
        setupCategoryDropdown();
        
        // Setup search functionality
        document.getElementById('searchBox').addEventListener('input', searchSoftware);
        
        // Pre-check purchase status for all software
        const purchaseChecks = allSoftware.map(async (s) => {
          const canDownload = await canDownloadSoftware(s.id);
          return { ...s, canDownload };
        });

        const softwareWithStatus = await Promise.all(purchaseChecks);
        allSoftware = softwareWithStatus;
        
        // Apply current filters
        applyFilters();
        
      } catch (e) {
        console.error("Error loading marketplace:", e);
        document.getElementById("softwareList").innerHTML = `
          <div class="empty-state">
            <h3>Error loading software</h3>
            <p>Please try again later</p>
          </div>
        `;
      }
    }

    async function loadMyUploads() {
      const token = localStorage.getItem("token");
      const container = document.getElementById("myUploadsList");
      if (!token) {
        container.innerHTML = "<p>Please login to view your uploads.</p>";
        return;
      }
      try {
        const res = await fetch(`${API}/software/my-uploads`, { headers: { "Authorization": `Bearer ${token}` } });
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const list = await res.json();
        container.innerHTML = "";
        if (list.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <h3>No uploads yet</h3>
              <p>Upload your first software to get started!</p>
            </div>
          `;
          return;
        }
        list.forEach(s => {
          const videoUrl = `${API.replace('/api','')}${s.videoUrl}`;
          container.innerHTML += `
            <div class="software-card">
              <div class="thumbnail-container" onclick="openVideoModal('${videoUrl}')">
                <video>
                  <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="play-overlay">
                  <span class="play-icon">‚ñ∂</span>
                </div>
              </div>
              <div class="card-content">
                <h3 class="software-title" title="${escapeHtml(s.title)}">${escapeHtml(s.title)}</h3>
                <div class="software-meta">
                  ${s.category ? `<span class="category-chip">${s.category}</span>` : ''}
                </div>
                ${s.description ? `<p style="font-size: 0.85rem; color: #606060; margin-bottom: 8px;">${escapeHtml(s.description)}</p>` : ''}
                <div class="software-price">$${s.price.toFixed(2)}</div>
                <div class="card-actions">
                  <button class="btn-download" onclick="event.stopPropagation(); downloadSoftware(${s.id}, '${escapeHtml(s.title)}')">
                    üì• Download
                  </button>
                  <button class="btn-edit" onclick="event.stopPropagation(); editSoftware(${s.id})">‚úèÔ∏è Edit</button>
                </div>
              </div>
            </div>`;
        });
      } catch (e) {
        console.error("Error loading uploads:", e);
        container.innerHTML = `<p>‚ùå ${e.message}</p>`;
      }
    }

    async function loadMyPurchases() {
      const token = localStorage.getItem("token");
      const container = document.getElementById("myPurchasesList");
      if (!token) {
        container.innerHTML = "<p>Please login to view your purchases.</p>";
        return;
      }
      try {
        const res = await fetch(`${API}/software/my-purchases`, { headers: { "Authorization": `Bearer ${token}` } });
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const purchases = await res.json();
        container.innerHTML = "";
        if (purchases.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <h3>No purchases yet</h3>
              <p>Purchase some software from the marketplace!</p>
            </div>
          `;
          return;
        }
        purchases.forEach(p => {
          const s = p.software;
          const videoUrl = `${API.replace('/api','')}${s.videoUrl}`;
          container.innerHTML += `
            <div class="software-card">
              <div class="thumbnail-container" onclick="openVideoModal('${videoUrl}')">
                <video>
                  <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="play-overlay">
                  <span class="play-icon">‚ñ∂</span>
                </div>
              </div>
              <div class="card-content">
                <h3 class="software-title" title="${escapeHtml(s.title)}">${escapeHtml(s.title)} <span class="purchase-badge">Purchased</span></h3>
                <div class="software-meta">
                  ${s.category ? `<span class="category-chip">${s.category}</span>` : ''}
                </div>
                ${s.description ? `<p style="font-size: 0.85rem; color: #606060; margin-bottom: 8px;">${escapeHtml(s.description)}</p>` : ''}
                <div class="software-meta">Paid: $${p.pricePaid.toFixed(2)} ‚Ä¢ ${new Date(p.purchaseDate).toLocaleDateString()}</div>
                <div class="card-actions">
                  <button class="btn-download" onclick="event.stopPropagation(); downloadSoftware(${s.id}, '${escapeHtml(s.title)}')">
                    üì• Download
                  </button>
                </div>
              </div>
            </div>`;
        });
      } catch (e) {
        console.error("Error loading purchases:", e);
        container.innerHTML = `<p>‚ùå ${e.message}</p>`;
      }
    }

    // Edit software - Load software details and show edit form
    async function editSoftware(id) {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Please login to edit software.");
        return;
      }

      try {
        // Fetch software details
        const res = await fetch(`${API}/software/${id}`, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(`Error ${res.status}`);

        const software = await res.json();
        currentEditingSoftware = software;

        // Populate edit form
        document.getElementById("editId").value = software.id;
        document.getElementById("editTitle").value = software.title;
        document.getElementById("editPrice").value = software.price;
        document.getElementById("editCategory").value = software.category || '';
        document.getElementById("editDescription").value = software.description || '';

        // Show edit form
        showEditForm();

      } catch (e) {
        console.error("Error loading software details:", e);
        alert("‚ùå Error loading software details. Please try again.");
      }
    }

    // Handle edit form submission
    document.getElementById("editForm").onsubmit = async (e) => {
      e.preventDefault();

      const token = localStorage.getItem("token");
      if (!token) {
        alert("Please login to edit software.");
        return;
      }

      if (!currentEditingSoftware) {
        alert("No software selected for editing.");
        return;
      }

      const formData = new FormData();
      formData.append("title", document.getElementById("editTitle").value);
      formData.append("price", document.getElementById("editPrice").value);
      formData.append("category", document.getElementById("editCategory").value);
      formData.append("description", document.getElementById("editDescription").value);

      // Only append files if they are selected
      const videoFile = document.getElementById("editVideo").files[0];
      if (videoFile) {
        formData.append("video", videoFile);
      }

      const zipFile = document.getElementById("editZipFile").files[0];
      if (zipFile) {
        formData.append("zipFile", zipFile);
      }

      try {
        const res = await fetch(`${API}/software/update/${currentEditingSoftware.id}`, {
          method: "PUT",
          headers: { "Authorization": `Bearer ${token}` },
          body: formData
        });

        if (res.ok) {
          alert("‚úÖ Software updated successfully!");
          hideEditForm();
          // Refresh both marketplace and my uploads
          loadMarketplace();
          loadMyUploads();
        } else {
          const errorText = await res.text();
          alert(`‚ùå Update failed: ${errorText}`);
        }
      } catch (e) {
        console.error("Update error:", e);
        alert("‚ùå Network error during update. Please try again.");
      }
    };

    // PayPal payment integration
    async function purchaseSoftware(softwareId, price, softwareTitle = "Software") {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Please login to purchase software.");
        return;
      }

      try {
        // Show loading state
        const buyButton = document.getElementById(`buy-btn-${softwareId}`);
        const originalText = buyButton.textContent;
        buyButton.textContent = "‚è≥ Processing...";
        buyButton.disabled = true;

        // Store button state for later restoration
        activePayPalButtons[softwareId] = { button: buyButton, originalText };

        // Create PayPal payment
        const paymentResponse = await fetch(`${API}/payment/create-payment`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({
            softwareId: softwareId,
            softwareTitle: softwareTitle
          })
        });

        if (!paymentResponse.ok) {
          const errorText = await paymentResponse.text();
          throw new Error(`Payment creation failed: ${errorText}`);
        }

        const paymentData = await paymentResponse.json();

        // Redirect to PayPal approval URL in a popup
        const width = 600;
        const height = 700;
        const left = (window.innerWidth - width) / 2;
        const top = (window.innerHeight - height) / 2;

        const paypalWindow = window.open(
          paymentData.approvalUrl,
          'PayPal',
          `width=${width},height=${height},top=${top},left=${left}`
        );

        // Check if popup was blocked
        if (!paypalWindow || paypalWindow.closed || typeof paypalWindow.closed === 'undefined') {
          // If popup blocked, redirect in same window
          window.location.href = paymentData.approvalUrl;
          return;
        }

        // Poll for payment completion
        const checkPayment = setInterval(async () => {
          if (paypalWindow.closed) {
            clearInterval(checkPayment);

            // Clear cache for this software
            delete purchaseStatusCache[softwareId];

            // Check if purchase was successful
            const verifyResponse = await fetch(`${API}/payment/purchases/check/${softwareId}`, {
              headers: {
                "Authorization": `Bearer ${token}`
              }
            });

            if (verifyResponse.ok) {
              const result = await verifyResponse.json();
              if (result.hasPurchased) {
                alert("‚úÖ Payment successful! You can now download the software.");
                // Refresh UI
                const activeTab = document.querySelector('.tab-content.active').id;
                if (activeTab === 'marketplaceTab') loadMarketplace();
                else if (activeTab === 'myPurchasesTab') loadMyPurchases();
              } else {
                alert("‚ùå Payment was not completed. Please try again.");
              }
            } else {
              alert("‚ùå Payment verification failed. Please check your purchases.");
            }

            // Restore button
            if (activePayPalButtons[softwareId]) {
              activePayPalButtons[softwareId].button.textContent = activePayPalButtons[softwareId].originalText;
              activePayPalButtons[softwareId].button.disabled = false;
              delete activePayPalButtons[softwareId];
            }
          }
        }, 1000);

      } catch (error) {
        console.error("Payment error:", error);
        alert("‚ùå Payment initialization failed. Please try again.");

        // Restore button
        if (activePayPalButtons[softwareId]) {
          activePayPalButtons[softwareId].button.textContent = activePayPalButtons[softwareId].originalText;
          activePayPalButtons[softwareId].button.disabled = false;
          delete activePayPalButtons[softwareId];
        }
      }
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    async function checkAdminStatus() {
      const token = localStorage.getItem("token");
      if (!token) return;
      
      // First check the stored value for immediate UI update
      const storedIsAdmin = localStorage.getItem('isAdmin') === 'true';
      if (storedIsAdmin) {
        document.querySelector('.admin-btn').style.display = 'inline-block';
      }
      
      // Then verify with the server
      try {
        const res = await fetch(`${API}/auth/check-admin`, { headers: { "Authorization": `Bearer ${token}` } });
        if (res.ok) {
          const isAdmin = await res.json();
          localStorage.setItem('isAdmin', isAdmin);
          if (isAdmin) {
            document.querySelector('.admin-btn').style.display = 'inline-block';
            document.getElementById('adminBadge').style.display = 'inline';
          } else {
            document.querySelector('.admin-btn').style.display = 'none';
            document.getElementById('adminBadge').style.display = 'none';
          }
        }
      } catch (e) {
        console.error("Admin check failed:", e);
      }
    }

    document.getElementById("uploadForm").onsubmit = async (e) => {
      e.preventDefault();
      const token = localStorage.getItem("token");
      if (!token) return alert("Please login to upload.");
      const formData = new FormData(e.target);
      try {
        const res = await fetch(`${API}/software/upload`, {
          method: "POST", 
          headers: { "Authorization": `Bearer ${token}` }, 
          body: formData
        });
        if (res.ok) {
          alert("‚úÖ Upload successful!");
          hideUploadForm();
          loadMarketplace(); // Reload to show new software
          loadMyUploads();
        } else {
          alert(`‚ùå Upload failed: ${await res.text()}`);
        }
      } catch (e) {
        console.error("Upload error:", e);
        alert("‚ùå Network error during upload.");
      }
    };

    window.onload = function() {
      // Check if user is logged in
      const token = localStorage.getItem("token");
      if (!token) {
        // Redirect to login if not authenticated
        window.location.href = 'index.html';
        return;
      }

      showTab("marketplace"); // Default tab
      checkAdminStatus();
    };
  </script>
</body>
</html>
